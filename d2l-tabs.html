<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-fastdom-import/fastdom.html">
<link rel="import" href="../d2l-icons/d2l-icon.html">
<link rel="import" href="../d2l-polymer-behaviors/d2l-id.html">
<link rel="import" href="../d2l-polymer-behaviors/d2l-dom-focus.html">
<link rel="import" href="../d2l-polymer-behaviors/d2l-focusable-arrowkeys-behavior.html">
<link rel="import" href="d2l-tab.html">
<link rel="import" href="d2l-tab-panel.html">

<!--
`d2l-tabs`
Polymer-based web components for tabs

@demo demo/index.html
-->

<dom-module id="d2l-tabs">

	<template strip-whitespace>
		<style>

			:host {
				box-sizing: border-box;
				display: block;
			}

			.d2l-tabs-container {
				border-bottom: 1px solid var(--d2l-color-gypsum);
				display: flex;
				padding-bottom: 4px;
				width: 100%;
				@apply --d2l-body-compact-text;
			}

			.d2l-tabs-container-list {
				flex: auto;
			}

			.d2l-tabs-container-ext {
				flex: none;
			}

		</style>
		<div class="d2l-tabs-container">
			<span class="d2l-tabs-focus-start" tabindex="0"></span>
			<div class="d2l-tabs-container-list"></div>
			<span class="d2l-tabs-focus-end" tabindex="0"></span>
			<div class="d2l-tabs-container-ext"><slot name="ext"></slot></div>
		</div>
		<div>
			<slot></slot>
		</div>
	</template>

	<script>
		Polymer({
			is: 'd2l-tabs',

			hostAttributes: {
				'role': 'tablist'
			},

			properties: {

				/**
				 * Indicates whether tabs are automatically activated on focus.
				 */
				noAutoSelect: {
					type: Boolean
				}

			},

			listeners: {
				'd2l-tab-selected': '_handleTabSelected',
				'd2l-tab-panel-selected': '_handleTabPanelSelected'
			},

			behaviors: [
				D2L.PolymerBehaviors.FocusableArrowKeysBehavior
			],

			ready: function() {
				this._handleDomChanges = this._handleDomChanges.bind(this);
				this._handleTabFocus = this._handleTabFocus.bind(this);
				this._handleFocusTrapStart = this._handleFocusTrapStart.bind(this);
				this._handleFocusTrapEnd = this._handleFocusTrapEnd.bind(this);
			},

			attached: function() {
				Polymer.RenderStatus.afterNextRender(this, function() {
					var tabsList = Polymer.dom(this.root).querySelector('.d2l-tabs-container-list');
					Polymer.dom(this).observeNodes(this._handleDomChanges);

					this.arrowKeyFocusablesContainer = tabsList;
					this.arrowKeyFocusablesProvider = function() {
						return this._getFocusableTabs(this._tabs);
					}.bind(this);

					tabsList.addEventListener('focus', this._handleTabFocus, true);
					Polymer.dom(this.root).querySelector('.d2l-tabs-focus-start').addEventListener('focus', this._handleFocusTrapStart);
					Polymer.dom(this.root).querySelector('.d2l-tabs-focus-end').addEventListener('focus', this._handleFocusTrapEnd);
				}.bind(this));
			},

			detached: function() {
				var tabsList = Polymer.dom(this.root).querySelector('.d2l-tabs-container-list');
				tabsList.removeEventListener('focus', this._handleTabFocus, true);
				Polymer.dom(this.root).querySelector('.d2l-tabs-focus-start').removeEventListener('focus', this._handleFocusTrapStart);
				Polymer.dom(this.root).querySelector('.d2l-tabs-focus-end').removeEventListener('focus', this._handleFocusTrapEnd);
			},

			_focusSelected: function() {
				var selectedTab = Polymer.dom(this.root).querySelector('d2l-tab[aria-selected]');
				if (selectedTab) {
					fastdom.mutate(function() {
						selectedTab.focus();
					});
				}
			},

			_getFocusableTabs: function(tabs) {
				if (!tabs || tabs.length === 0) {
					return Promise.resolve([]);
				}
				return new Promise(function(resolve) {
					fastdom.measure(function() {
						var focusableTabs = [];
						for (var i = 0; i < tabs.length; i++) {
							if (window.getComputedStyle(tabs[i], null).getPropertyValue('display') !== 'none') {
								focusableTabs.push(tabs[i]);
							}
						}
						resolve(focusableTabs);
					});
				});
			},

			_handleFocusTrapStart: function(e) {
				if (e.relatedTarget && e.relatedTarget.tagName === 'D2L-TAB') {
					var previousFocusable = D2L.Dom.Focus.getPreviousFocusable(e.target, false);
					if (previousFocusable) fastdom.mutate(function() { previousFocusable.focus(); });
				} else {
					this._focusSelected();
				}
			},

			_handleFocusTrapEnd: function(e) {
				if (e.relatedTarget && e.relatedTarget.tagName !== 'D2L-TAB') {
					this._focusSelected();
				} else {
					var nextFocusable = D2L.Dom.Focus.getNextFocusable(e.target, false);
					if (nextFocusable) fastdom.mutate(function() { nextFocusable.focus(); });
				}
			},

			_handleTabFocus: function(e) {
				if (!this.noAutoSelect && e.target.tagName === 'D2L-TAB' && !e.target.selected) {
					e.target.selected = true;
				}
			},

			_handleTabSelected: function(e) {

				e.stopPropagation();

				var selectedTab = Polymer.dom(e).rootTarget;
				var selectedPanel = this.querySelector('#' + selectedTab.getAttribute('aria-controls'));

				selectedPanel.selected = true;

				fastdom.mutate(function() {
					for (var i = 0; i < this._tabs.length; i++) {
						var tab = this._tabs[i];
						if (tab.selected && tab !== selectedTab) {
							tab.selected = false;
							this.querySelector('#' + tab.getAttribute('aria-controls')).selected = false;
						}
					}
				}.bind(this));

			},

			_handleTabPanelSelected: function(e) {
				var panel = Polymer.dom(e).rootTarget;
				var tab = Polymer.dom(this.root).querySelector('[aria-controls="' + panel.id + '"]');
				if (tab) {
					tab.selected = true;
				}
			},

			_handleDomChanges: function(info) {

				var panels = this.getEffectiveChildren();

				fastdom.mutate(function() {

					for (var i = 0; i < info.removedNodes.length; i++) {
						var removedNode = info.removedNodes[i];
						if (removedNode.tagName === 'D2L-TAB-PANEL' && removedNode.id.length > 0) {
							var tabToRemove = Polymer.dom(this.root).querySelector('[aria-controls="' + removedNode.id + '"]');
							tabToRemove.parentNode.removeChild(tabToRemove);
						}
					}

					var tabsList = Polymer.dom(this.root).querySelector('.d2l-tabs-container-list');
					var hasSelectedTab = false;

					for (var j = 0; j < info.addedNodes.length; j++) {
						if (info.addedNodes[j].tagName === 'D2L-TAB-PANEL') {

							var panel = info.addedNodes[j];
							if (panel.id.length === 0) {
								panel.id = D2L.Id.getUniqueId();
							}

							var panelIndex = panels.indexOf(panel);

							var tab = document.createElement('d2l-tab');
							tab.setAttribute('aria-controls', panel.id);
							tab.selected = panel.selected;
							tab.text = panel.text;
							if (tab.selected) hasSelectedTab = true;

							if (panelIndex >= tabsList.children.length) {
								tabsList.appendChild(tab);
							} else {
								tabsList.insertBefore(tab, tabsList.children[panelIndex]);
							}

						}
					}

					this._tabs = Array.prototype.slice.call(tabsList.querySelectorAll('[tabindex]'));

					if (!this._initialized && !hasSelectedTab && this._tabs.length > 0) {
						this._initialized = true;
						this._tabs[0].selected = true;
					}

				}.bind(this));

			}

		});
	</script>

</dom-module>
